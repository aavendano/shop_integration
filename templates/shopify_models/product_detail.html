{% extends 'core/base.html' %}
{% load static %}
{% load shopify_extras %}

{% block content %}
<section class="section">
    <div class="container">
        <nav class="breadcrumb" aria-label="breadcrumbs">
            <ul>
                <li><a href="{% url 'shopify_models:product_list' %}">Products</a></li>
                <li class="is-active"><a href="#" aria-current="page">{{ product.title }}</a></li>
            </ul>
        </nav>

        {# Product Header #}
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <span><h1 class="title is-3">{{ product.title }}</h1></span>
                        <span><p class="subtitle is-5">{{ product.vendor|placeholder:"No vendor" }} | {{ product.product_type|placeholder:"No type" }}</p></span>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <form action="{% url 'shopify_models:product_sync' product.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="button is-primary">
                            <span class="icon"><i class="lucide-refresh-cw"></i></span>
                            <span>Sync to Shopify</span>
                        </button>
                    </form>
                </div>
                
                <div class="level-item">
                    {% if price_list_configured %}
                    <form action="{% url 'prices:sync_product' product.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="button is-success">
                            <span class="icon"><i class="lucide-dollar-sign"></i></span>
                            <span>Sync Prices</span>
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'prices:setup' %}" class="button is-warning">
                        <span class="icon"><i class="lucide-alert-circle"></i></span>
                        <span>Setup Pricing</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Tabs Navigation #}
        <div class="tabs is-boxed">
            <ul>
                <li class="is-active" data-tab="overview">
                    <a>
                        <span class="icon is-small"><i class="lucide-info"></i></span>
                        <span>Overview</span>
                    </a>
                </li>
                <li data-tab="images">
                    <a>
                        <span class="icon is-small"><i class="lucide-image"></i></span>
                        <span>Images ({{ images.count }})</span>
                    </a>
                </li>
                <li data-tab="variants">
                    <a>
                        <span class="icon is-small"><i class="lucide-package"></i></span>
                        <span>Variants ({{ product.variants.count }})</span>
                    </a>
                </li>
                <li data-tab="inventory">
                    <a>
                        <span class="icon is-small"><i class="lucide-warehouse"></i></span>
                        <span>Inventory</span>
                    </a>
                </li>
                <!-- <li data-tab="locations">
                    <a>
                        <span class="icon is-small"><i class="lucide-map-pin"></i></span>
                        <span>Locations ({{ locations.count }})</span>
                    </a>
                </li> -->
            </ul>
        </div>

        {# Tab Content #}
        <div class="tab-content">
            {# OVERVIEW TAB #}
            <div class="tab-pane is-active" id="overview">
                <div class="columns">
                    <div class="column is-one-third">
                        <div class="card">
                            <div class="card-image">
                                {% if product.images.first %}
                                <figure class="image is-4by3">
                                    <img src="{{ product.images.first.src }}" alt="{{ product.title }}">
                                </figure>
                                {% else %}
                                <div class="has-text-centered py-6 has-background-light">
                                    <span class="icon is-large has-text-grey-light"><i class="lucide-image"></i></span>
                                    <p class="has-text-grey">No image available</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-content">
                                <div class="content">
                                    <div class="tags mb-3">
                                        {% for tag in product.tag_list %}
                                        <span class="tag is-info is-light">{{ tag }}</span>
                                        {% empty %}
                                        <span class="tag is-light">No tags</span>
                                        {% endfor %}
                                    </div>
                                    <p><strong>Shopify ID:</strong> {{ product.shopify_id|shopify_id_badge }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <header class="card-header">
                                <p class="card-header-title">Product Details</p>
                            </header>
                            <div class="card-content">
                                <div class="columns is-multiline">
                                    <div class="column is-half">
                                        <p class="heading">Handle</p>
                                        <p>{{ product.handle|placeholder }}</p>
                                    </div>
                                    <div class="column is-half">
                                        <p class="heading">Product Type</p>
                                        <p>{{ product.product_type|placeholder }}</p>
                                    </div>
                                    <div class="column is-half">
                                        <p class="heading">Vendor</p>
                                        <p>{{ product.vendor|placeholder }}</p>
                                    </div>
                   
                                    
                                    <div class="column is-half">
                                        <p class="heading">Created At</p>
                                        <p>{{ product.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    </div>
                                    <div class="column is-half">
                                        <p class="heading">Updated At</p>
                                        <p>{{ product.updated_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if product.description %}
                        <div class="card mt-4">
                            <header class="card-header">
                                <p class="card-header-title">Description (HTML)</p>
                            </header>
                            <div class="card-content">
                                <div class="content">
                                    {{ product.description|safe }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# IMAGES TAB #}
            <div class="tab-pane" id="images">
                {% if images %}
                <div class="columns is-multiline">
                    {% for image in images %}
                    <div class="column is-one-third">
                        <div class="card">
                            <div class="card-image">
                                <figure class="image is-4by3">
                                    <img src="{{ image.src }}" alt="{{ product.title }}">
                                </figure>
                            </div>
                            <div class="card-content">
                                <div class="content">
                                    <p class="heading">Position</p>
                                    <p>{{ image.position }}</p>
                                    <p class="heading">Shopify ID</p>
                                    <p>{{ image.shopify_id|truncate_id:12|placeholder }}</p>
                                    <p class="heading">Created At</p>
                                    <p>{{ image.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    <p class="heading">URL</p>
                                    <p class="is-size-7" style="word-break: break-all;">{{ image.src }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="notification is-light">
                    <span class="icon"><i class="lucide-image"></i></span>
                    <span>No images found for this product.</span>
                </div>
                {% endif %}
            </div>

            {# VARIANTS TAB #}
            <div class="tab-pane" id="variants">
                <div class="level mb-4">
                    <div class="level-left">
                        <div class="level-item">
                            <p class="subtitle">All product variants</p>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <a href="{% url 'shopify_models:variant_create' product.id %}" class="button is-primary">
                                <span class="icon"><i class="lucide-plus"></i></span>
                                <span>Add Variant</span>
                            </a>
                        </div>
                    </div>
                </div>

                {% if product.variants %}
                {% for variant in product.variants %}
                <div class="card mb-4">
                    <header class="card-header">
                        <p class="card-header-title">
                            <span class="icon"><i class="lucide-package"></i></span>
                            <span>{{ variant.title|placeholder:"Default" }} - {{ variant.supplier_sku|placeholder:"No SKU" }}</span>
                        </p>
                        <div class="card-header-icon">
                            <div class="buttons are-small">
                                <a href="{% url 'shopify_models:variant_update' product.id variant.id %}" class="button is-info">
                                    <span class="icon is-small"><i class="lucide-edit"></i></span>
                                </a>
                                <a href="{% url 'shopify_models:variant_delete' product.id variant.id %}" class="button is-danger">
                                    <span class="icon is-small"><i class="lucide-trash"></i></span>
                                </a>
                            </div>
                        </div>
                    </header>
                    <div class="card-content">
                        <div class="columns is-multiline">
                            <div class="column is-one-quarter">
                                <p class="heading">Shopify ID</p>
                                <p>{{ variant.shopify_id|shopify_id_badge }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Supplier SKU</p>
                                <p>{{ variant.supplier_sku|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Barcode</p>
                                <p>{{ variant.barcode|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Position</p>
                                <p>{{ variant.position }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Price</p>
                                <p>{{ variant.price|currency }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Compare at Price</p>
                                <p>{{ variant.compare_at_price|currency|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Weight</p>
                                <p>{{ variant.grams|format_weight }}</p>
                            </div>
                            <!-- <div class="column is-one-quarter">
                                <p class="heading">Inventory Quantity</p>
                                <p>{{ variant.inventory_quantity|placeholder:"0" }}</p>
                            </div> -->
                            <div class="column is-one-quarter">
                                <p class="heading">Option 1</p>
                                <p>{{ variant.option1|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Option 2</p>
                                <p>{{ variant.option2|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Option 3</p>
                                <p>{{ variant.option3|placeholder }}</p>
                            </div>
                            <!-- <div class="column is-one-quarter">
                                <p class="heading">Fulfillment Service</p>
                                <p>{{ variant.fulfillment_service|placeholder }}</p>
                            </div> -->
                            <div class="column is-one-quarter">
                                <p class="heading">Inventory Management</p>
                                <p>{{ variant.inventory_management|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Inventory Policy</p>
                                <p>{{ variant.inventory_policy|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Requires Shipping</p>
                                <p>{{ variant.requires_shipping|boolean_badge }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Taxable</p>
                                <p>{{ variant.taxable|boolean_badge }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Created At</p>
                                <p>{{ variant.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                            </div>
                            <div class="column is-one-quarter">
                                <p class="heading">Updated At</p>
                                <p>{{ variant.updated_at|date:"Y-m-d H:i"|placeholder }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="notification is-light">
                    <span class="icon"><i class="lucide-package"></i></span>
                    <span>No variants found for this product.</span>
                </div>
                {% endif %}
            </div>

            {# INVENTORY TAB #}
            <div class="tab-pane" id="inventory">
                {% if variants_data %}
                {% for variant_info in variants_data %}
                <div class="card mb-4">
                    <header class="card-header has-background-light">
                        <p class="card-header-title">
                            <span class="icon"><i class="lucide-package"></i></span>
                            <span>{{ variant_info.variant.title|placeholder:"Default" }} ({{ variant_info.variant.supplier_sku|placeholder:"No SKU" }})</span>
                        </p>
                    </header>
                    <div class="card-content">
                        {% if variant_info.inventory_item %}
                        {# Inventory Item Details #}
                        <div class="box">
                            <h4 class="title is-5">
                                <span class="icon"><i class="lucide-box"></i></span>
                                <span>Inventory Item</span>
                            </h4>
                            <div class="columns is-multiline">
                                <div class="column is-one-quarter">
                                    <p class="heading">Shopify ID</p>
                                    <p>{{ variant_info.inventory_item.shopify_id|shopify_id_badge }}</p>
                                </div>
                                <div class="column is-one-quarter">
                                    <p class="heading">Shopify SKU</p>
                                    <p>{{ variant_info.inventory_item.shopify_sku|placeholder }}</p>
                                </div>
                                <div class="column is-one-quarter">
                                    <p class="heading">Tracked</p>
                                    <p>{{ variant_info.inventory_item.tracked|boolean_badge }}</p>
                                </div>
                                <div class="column is-one-quarter">
                                    <p class="heading">Requires Shipping</p>
                                    <p>{{ variant_info.inventory_item.requires_shipping|boolean_badge }}</p>
                                </div>
                                <div class="column is-one-quarter">
                                    <p class="heading">Unit Cost</p>
                                    <p>{{ variant_info.inventory_item.unit_cost_amount|currency:variant_info.inventory_item.unit_cost_currency|placeholder }}</p>
                                </div>
                                <!-- <div class="column is-one-quarter">
                                    <p class="heading">Locations Count</p>
                                    <p>{{ variant_info.inventory_item.locations_count|placeholder }}</p>
                                </div> -->
                                <div class="column is-one-quarter">
                                    <p class="heading">Created At</p>
                                    <p>{{ variant_info.inventory_item.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                                </div>
                                <div class="column is-one-quarter">
                                    <p class="heading">Updated At</p>
                                    <p>{{ variant_info.inventory_item.updated_at|date:"Y-m-d H:i"|placeholder }}</p>
                                </div>
                            </div>
                        </div>

                        {# Inventory Levels #}
                        {% if variant_info.inventory_levels %}
                        <div class="box mt-4">
                            <h4 class="title is-5">
                                <span class="icon"><i class="lucide-warehouse"></i></span>
                                <span>Inventory Levels ({{ variant_info.inventory_levels.count }})</span>
                            </h4>
                            <div class="table-container">
                                <table class="table is-fullwidth is-striped is-hoverable">
                                    <thead>
                                        <tr>
                                            <th>Shopify ID</th>
                                            <th>Quantities</th>
                                            <th>Can Deactivate</th>
                                            <th>Sync Status</th>
                                            <th>Source Updated</th>
                                            <th>Synced At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for level in variant_info.inventory_levels %}
                                        <tr>
                                            <td>{{ level.shopify_id|truncate_id:12|placeholder }}</td>
                                            <td>
                                                {% if level.quantities %}
                                                <pre class="is-size-7">{{ level.quantities|format_json }}</pre>
                                                {% else %}
                                                â€”
                                                {% endif %}
                                            </td>
                                            <!-- <td>{{ level.can_deactivate|boolean_badge }}</td> -->
                                            <td>{{ level.sync_pending|sync_status_badge }}</td>
                                            <td>{{ level.source_updated_at|date:"Y-m-d H:i"|placeholder }}</td>
                                            <td>{{ level.synced_at|date:"Y-m-d H:i"|placeholder }}</td>
                                        </tr>
                                        <!-- {% if level.deactivation_alert %}
                                        <tr>
                                            <td colspan="6">
                                                <div class="notification is-warning is-light">
                                                    <strong>Deactivation Alert:</strong> {{ level.deactivation_alert }}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %} -->
                                        <!-- {% if level.scheduled_changes %}
                                        <tr>
                                            <td colspan="6">
                                                <details>
                                                    <summary class="has-text-weight-semibold">Scheduled Changes</summary>
                                                    <pre class="is-size-7 mt-2">{{ level.scheduled_changes|format_json }}</pre>
                                                </details>
                                            </td>
                                        </tr>
                                        {% endif %} -->
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="notification is-light mt-4">
                            <span class="icon"><i class="lucide-info"></i></span>
                            <span>No inventory levels found for this item.</span>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="notification is-warning is-light">
                            <span class="icon"><i class="lucide-alert-triangle"></i></span>
                            <span>No inventory item linked to this variant.</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="notification is-light">
                    <span class="icon"><i class="lucide-package"></i></span>
                    <span>No variants found for this product.</span>
                </div>
                {% endif %}
            </div>

            {# LOCATIONS TAB - REMOVED: Location model has been removed, location is now managed via .env #}
            <!-- <div class="tab-pane" id="locations">
                {% if locations %}
                <div class="columns is-multiline">
                    {% for location in locations %}
                    <div class="column is-half">
                        <div class="card">
                            <header class="card-header">
                                <p class="card-header-title">
                                    <span class="icon"><i class="lucide-map-pin"></i></span>
                                    <span>{{ location.name }}</span>
                                </p>
                                <div class="card-header-icon">
                                    {{ location.is_active|active_badge }}
                                </div>
                            </header>
                            <div class="card-content">
                                <div class="columns is-multiline">
                                    <div class="column is-half">
                                        <p class="heading">Shopify ID</p>
                                        <p>{{ location.shopify_id|truncate_id:12|placeholder }}</p>
                                    </div>
                                    <div class="column is-half">
                                        <p class="heading">Last Inventory Sync</p>
                                        <p>{{ location.last_inventory_sync_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    </div>
                                    <div class="column is-full">
                                        <p class="heading">Address</p>
                                        <p>{{ location.address|format_address }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Activatable</p>
                                        <p>{{ location.activatable|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Deactivatable</p>
                                        <p>{{ location.deactivatable|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Deletable</p>
                                        <p>{{ location.deletable|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Fulfills Online Orders</p>
                                        <p>{{ location.fulfills_online_orders|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Has Active Inventory</p>
                                        <p>{{ location.has_active_inventory|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-one-third">
                                        <p class="heading">Ships Inventory</p>
                                        <p>{{ location.ships_inventory|boolean_badge }}</p>
                                    </div>
                                    <div class="column is-full">
                                        <p class="heading">Has Unfulfilled Orders</p>
                                        <p>{{ location.has_unfulfilled_orders|boolean_badge }}</p>
                                    </div>
                                    {% if location.local_pickup_settings %}
                                    <div class="column is-full">
                                        <details>
                                            <summary class="has-text-weight-semibold">Local Pickup Settings</summary>
                                            <pre class="is-size-7 mt-2">{{ location.local_pickup_settings|format_json }}</pre>
                                        </details>
                                    </div>
                                    {% endif %}
                                    <div class="column is-half">
                                        <p class="heading">Created At</p>
                                        <p>{{ location.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    </div>
                                    <div class="column is-half">
                                        <p class="heading">Updated At</p>
                                        <p>{{ location.updated_at|date:"Y-m-d H:i"|placeholder }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="notification is-light">
                    <span class="icon"><i class="lucide-map-pin"></i></span>
                    <span>No locations found.</span>
                </div>
                {% endif %}
            </div> -->
        </div>
    </div>
</section>

<script>
// Simple tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tabs li');
    const tabPanes = document.querySelectorAll('.tab-pane');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove('is-active'));
            tabPanes.forEach(pane => pane.classList.remove('is-active'));
            
            // Add active class to clicked tab and corresponding pane
            this.classList.add('is-active');
            document.getElementById(targetTab).classList.add('is-active');
        });
    });
});
</script>

<style>
.tab-pane {
    display: none;
}

.tab-pane.is-active {
    display: block;
}

.heading {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #7a7a7a;
    margin-bottom: 0.25rem;
}

pre {
    background-color: #f5f5f5;
    padding: 0.5rem;
    border-radius: 4px;
    overflow-x: auto;
}

details summary {
    cursor: pointer;
    user-select: none;
}

details summary:hover {
    color: #3273dc;
}
</style>
{% endblock %}