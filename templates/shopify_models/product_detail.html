{% extends 'core/base.html' %}
{% load static %}
{% load shopify_extras %}

{% block content %}
<s-page heading="{{ product.title }}">
    <s-link slot="breadcrumb-actions" href="{% url 'shopify_models:product_list' %}">Products</s-link>

    <div slot="primary-action">
        <form action="{% url 'shopify_models:product_sync' product.id %}" method="post">
            {% csrf_token %}
            <s-button type="submit" variant="primary" icon="refresh">Sync to Shopify</s-button>
        </form>
    </div>

    <div slot="secondary-actions">
        {% if price_list_configured %}
        <form action="{% url 'prices:sync_product' product.id %}" method="post">
            {% csrf_token %}
            <s-button type="submit" icon="attach-money">Sync Prices</s-button>
        </form>
        {% else %}
        <s-button href="{% url 'prices:setup' %}" tone="warning" icon="alert-circle">Setup Pricing</s-button>
        {% endif %}
    </div>

    <s-section heading="Product Overview">
       <s-grid gridTemplateColumns="1fr 2fr" gap="base">
           <s-grid-item>
               <s-box border="base" borderRadius="base" padding="base">
                   {% if product.images.first %}
                       <s-image src="{{ product.images.first.src }}" alt="{{ product.title }}" inlineSize="fill"></s-image>
                   {% else %}
                       <s-stack align-items="center" justify-content="center" style="height: 200px; background: #f4f6f8;">
                           <s-icon type="image-none" size="large" color="subdued"></s-icon>
                       </s-stack>
                   {% endif %}
                   <s-stack gap="small" class="mt-4" style="margin-top: 1rem;">
                       <s-text type="strong">Tags:</s-text>
                       <s-stack direction="inline" wrap>
                           {% for tag in product.tag_list %}
                               <s-badge>{{ tag }}</s-badge>
                           {% empty %}
                               <s-text color="subdued">No tags</s-text>
                           {% endfor %}
                       </s-stack>
                       <s-text type="strong" style="margin-top: 0.5rem; display: block;">Shopify ID:</s-text>
                       <s-text>{{ product.shopify_id|shopify_id_badge }}</s-text>
                   </s-stack>
               </s-box>
           </s-grid-item>
           <s-grid-item>
               <s-box border="base" borderRadius="base" padding="base">
                   <s-grid gridTemplateColumns="1fr 1fr" gap="base">
                       <s-grid-item>
                           <s-text color="subdued">Handle</s-text>
                           <p>{{ product.handle|placeholder }}</p>
                       </s-grid-item>
                       <s-grid-item>
                           <s-text color="subdued">Product Type</s-text>
                           <p>{{ product.product_type|placeholder }}</p>
                       </s-grid-item>
                       <s-grid-item>
                           <s-text color="subdued">Vendor</s-text>
                           <p>{{ product.vendor|placeholder }}</p>
                       </s-grid-item>
                       <s-grid-item>
                           <s-text color="subdued">Created At</s-text>
                           <p>{{ product.created_at|date:"Y-m-d H:i"|placeholder }}</p>
                       </s-grid-item>
                       <s-grid-item>
                           <s-text color="subdued">Updated At</s-text>
                           <p>{{ product.updated_at|date:"Y-m-d H:i"|placeholder }}</p>
                       </s-grid-item>
                   </s-grid>

                   {% if product.description %}
                   <s-box style="margin-top: 1.5rem; border-top: 1px solid #dfe3e8; padding-top: 1rem;">
                       <s-text type="strong" style="margin-bottom: 0.5rem; display: block;">Description</s-text>
                       <div class="content">{{ product.description|safe }}</div>
                   </s-box>
                   {% endif %}
               </s-box>
           </s-grid-item>
       </s-grid>
    </s-section>

    {% if images %}
    <s-section heading="Images ({{ images.count }})">
        <s-grid gridTemplateColumns="repeat(auto-fill, minmax(150px, 1fr))" gap="base">
            {% for image in images %}
            <s-grid-item>
                <s-box border="base" borderRadius="base" padding="small">
                    <s-image src="{{ image.src }}" alt="Product Image" inlineSize="fill" style="aspect-ratio: 1; object-fit: cover;"></s-image>
                    <s-text color="subdued" size="small">Pos: {{ image.position }}</s-text>
                </s-box>
            </s-grid-item>
            {% endfor %}
        </s-grid>
    </s-section>
    {% endif %}

    <s-section heading="Variants ({{ product.variants.count }})">
        {% if product.variants.exists %}
            <s-stack gap="base">
                {% for variant in product.variants.all %}
                <s-box border="base" borderRadius="base" padding="base">
                    <s-stack gap="base">
                        <s-stack direction="inline" justify-content="space-between" align-items="center">
                            <s-heading>{{ variant.title|placeholder:"Default" }}</s-heading>
                            <s-button-group>
                                <s-button href="{% url 'shopify_models:variant_update' product.id variant.id %}" icon="edit" size="small"></s-button>
                                <s-button href="{% url 'shopify_models:variant_delete' product.id variant.id %}" icon="delete" tone="critical" size="small"></s-button>
                                <form action="{% url 'shopify_models:variant_add_location' product.id variant.id %}" method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <s-button type="submit" tone="warning" icon="location" size="small" accessibilityLabel="Add Location"></s-button>
                                </form>
                            </s-button-group>
                        </s-stack>

                        <s-grid gridTemplateColumns="repeat(auto-fill, minmax(150px, 1fr))" gap="base">
                            <s-grid-item>
                                <s-text color="subdued">SKU</s-text>
                                <p>{{ variant.supplier_sku|placeholder }}</p>
                            </s-grid-item>
                            <s-grid-item>
                                <s-text color="subdued">Barcode</s-text>
                                <p>{{ variant.barcode|placeholder }}</p>
                            </s-grid-item>
                            <s-grid-item>
                                <s-text color="subdued">Price</s-text>
                                <p>{{ variant.price|currency }}</p>
                            </s-grid-item>
                            <s-grid-item>
                                <s-text color="subdued">Inventory</s-text>
                                <p>{{ variant.inventory_management|placeholder }}</p>
                            </s-grid-item>
                        </s-grid>
                    </s-stack>
                </s-box>
                {% endfor %}
            </s-stack>
        {% else %}
            <s-banner tone="info">No variants found.</s-banner>
        {% endif %}

        <s-box class="mt-4" style="margin-top: 1rem;">
            <s-button href="{% url 'shopify_models:variant_create' product.id %}" icon="add">Add Variant</s-button>
        </s-box>
    </s-section>

    {% if variants_data %}
    <s-section heading="Inventory Levels">
        {% for variant_info in variants_data %}
            <s-box border="base" borderRadius="base" padding="base" class="mb-4" style="margin-bottom: 1rem;">
                <s-heading>{{ variant_info.variant.title|placeholder:"Default" }} ({{ variant_info.variant.supplier_sku|placeholder:"No SKU" }})</s-heading>
                {% if variant_info.inventory_levels %}
                    <s-table>
                        <s-table-header-row>
                            <s-table-header>Shopify ID</s-table-header>
                            <s-table-header>Quantities</s-table-header>
                            <s-table-header>Sync Status</s-table-header>
                            <s-table-header>Synced At</s-table-header>
                        </s-table-header-row>
                        <s-table-body>
                            {% for level in variant_info.inventory_levels %}
                            <s-table-row>
                                <s-table-cell>{{ level.shopify_id|truncate_id:12|placeholder }}</s-table-cell>
                                <s-table-cell>
                                    {% if level.quantities %}
                                        {{ level.quantities|format_json }}
                                    {% else %}
                                        â€”
                                    {% endif %}
                                </s-table-cell>
                                <s-table-cell>{{ level.sync_pending|sync_status_badge }}</s-table-cell>
                                <s-table-cell>{{ level.synced_at|date:"Y-m-d H:i"|placeholder }}</s-table-cell>
                            </s-table-row>
                            {% endfor %}
                        </s-table-body>
                    </s-table>
                {% else %}
                    <s-text color="subdued">No inventory levels found.</s-text>
                {% endif %}
            </s-box>
        {% endfor %}
    </s-section>
    {% endif %}

</s-page>
{% endblock %}
