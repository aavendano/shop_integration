{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<s-page heading="Products">
    <div slot="primary-action">
        <s-button form="bulk-sync-form" type="submit" disabled id="bulk-sync-btn" variant="primary">Sync Selected Prices</s-button>
    </div>
    <div slot="secondary-actions">
        <s-button id="selected-count-btn" disabled>0 selected</s-button>
    </div>

    <s-section heading="Filter Products">
        <form method="get">
            <s-grid gridTemplateColumns="repeat(auto-fill, minmax(200px, 1fr))" gap="base">
                {% for field in filter.form %}
                <s-grid-item>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;">{{ field.label }}</label>
                        {{ field }}
                    </div>
                </s-grid-item>
                {% endfor %}
            </s-grid>
            <s-stack gap="base" direction="inline" style="margin-top: 1rem;">
                <s-button type="submit" variant="primary">Filter</s-button>
                <s-button href="{% url 'shopify_models:product_list' %}">Reset</s-button>
            </s-stack>
        </form>
    </s-section>

    <s-section padding="none">
        <form id="bulk-sync-form" action="{% url 'prices:bulk_sync' %}" method="post">
            {% csrf_token %}
            <s-table>
                <s-table-header-row>
                    <s-table-header>
                        <s-checkbox id="select-all"></s-checkbox>
                    </s-table-header>
                    <s-table-header>Image</s-table-header>
                    <s-table-header>Title</s-table-header>
                    <s-table-header>Vendor</s-table-header>
                    <s-table-header>Type</s-table-header>
                    <s-table-header>Tags</s-table-header>
                    <s-table-header>Actions</s-table-header>
                </s-table-header-row>
                <s-table-body>
                    {% for product in products %}
                    <s-table-row>
                        <s-table-cell>
                            <s-checkbox name="product_ids" value="{{ product.id }}" class="product-checkbox"></s-checkbox>
                        </s-table-cell>
                        <s-table-cell>
                            {% if product.images.first %}
                                <s-thumbnail src="{{ product.images.first.src }}" alt="{{ product.title }}"></s-thumbnail>
                            {% else %}
                                <s-icon type="image-none" color="subdued"></s-icon>
                            {% endif %}
                        </s-table-cell>
                        <s-table-cell>
                            <s-text type="strong">{{ product.title }}</s-text>
                        </s-table-cell>
                        <s-table-cell>{{ product.vendor }}</s-table-cell>
                        <s-table-cell>{{ product.product_type }}</s-table-cell>
                        <s-table-cell>
                            <s-stack direction="inline" gap="small" wrap>
                                {% for tag in product.tag_list %}
                                <s-badge>{{ tag }}</s-badge>
                                {% endfor %}
                            </s-stack>
                        </s-table-cell>
                        <s-table-cell>
                            <s-button href="{% url 'shopify_models:product_detail' product.id %}" size="small">View</s-button>
                        </s-table-cell>
                    </s-table-row>
                    {% empty %}
                    <s-table-row>
                        <s-table-cell colspan="7">No products found.</s-table-cell>
                    </s-table-row>
                    {% endfor %}
                </s-table-body>
            </s-table>
        </form>

        {% if is_paginated %}
        <div style="padding: 1rem; display: flex; justify-content: center;">
             <s-button-group>
                {% if page_obj.has_previous %}
                <s-button href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</s-button>
                {% else %}
                <s-button disabled>Previous</s-button>
                {% endif %}

                <s-button disabled>Page {{ page_obj.number }}</s-button>

                {% if page_obj.has_next %}
                <s-button href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</s-button>
                {% else %}
                <s-button disabled>Next</s-button>
                {% endif %}
             </s-button-group>
        </div>
        {% endif %}
    </s-section>
</s-page>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const bulkBtn = document.getElementById('bulk-sync-btn');
        const countBtn = document.getElementById('selected-count-btn');

        function updateState() {
            let count = 0;
            checkboxes.forEach(cb => { if(cb.checked) count++; });

            if (bulkBtn) bulkBtn.disabled = count === 0;
            if (countBtn) countBtn.textContent = `${count} selected`;
        }

        if (selectAll) {
            selectAll.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                checkboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
                updateState();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                updateState();
            });
        });

        const form = document.getElementById('bulk-sync-form');
        if (form) {
            form.addEventListener('submit', (e) => {
                let count = 0;
                checkboxes.forEach(cb => { if(cb.checked) count++; });
                if (count > 0) {
                    if (!confirm(`Sync prices for ${count} product(s)?`)) {
                        e.preventDefault();
                    }
                }
            });
        }
    });
</script>
{% endblock %}
